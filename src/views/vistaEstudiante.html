<!-- para pruebas-->

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vista del Estudiante - Genuiz</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    .body1 {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 250px;
      background-color: #f8f9fa;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar img {
      width: 100px;
      border-radius: 50%;
    }

    .sidebar h4 {
      margin-top: 10px;
    }

    .btn-enter-exam {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      text-align: center;
      cursor: pointer;
      border-radius: 5px;
      text-decoration: none;
    }

    .btn-enter-exam:hover {
      background-color: #0056b3;
    }

    .scroll-padre {
      flex: 1;
      overflow-y: auto;
      width: 100%;
    }

    .scroll-bg {
      padding: 20px;
    }

    .scroll-div {
      width: 100%;
    }

    .results-container {
      display: flex;
      flex-direction: column;
    }

    .result-button {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      cursor: pointer;
      text-align: left;
    }

    .result-button:hover {
      background-color: #dee2e6;
    }

    #exam-viz, #result-viz {
      flex: 3;
      padding: 20px;
    }

    .active-result {
      background-color: #007bff;
      color: white;
    }

    .correct-answer {
      color: green;
      font-weight: bold;
    }

    .results-container {
      margin-top: 20px;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .results-table th {
      background-color: #f2f2f2;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="body1">
    <div class="sidebar">
      <img src="https://cdn-icons-png.flaticon.com/512/320/320333.png" alt="Estudiante">
      <h4>Estudiante</h4>
      <input type="text" id="examCode" class="form-control" placeholder="Código del Examen">
      <button class="btn-enter-exam" id="enterExamCode">Ingresar Código</button>
      <div class="scroll-padre">
        <div class="scroll-bg">
          <div class="scroll-div">
            <div class="results-container">
              <!-- Aquí se mostrarán los resultados de los exámenes -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Exam part  -->
    <div id="exam-viz"></div>
    <div id="result-viz"></div>
  </div>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    document.getElementById("enterExamCode").addEventListener("click", function () {
      const examCode = document.getElementById('examCode').value;
      if (examCode) {
        fetch(`/get-exam-by-code?code=${examCode}`)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
            } else {
              displayExam(data);
            }
          })
          .catch((error) => console.error('Error:', error));
      } else {
        alert('Por favor, ingrese un código de examen.');
      }
    });

    window.onload = function () {
      fetch('/get-student-results')
        .then(response => response.json())
        .then(results => {
          const container = document.querySelector('.results-container');
          results.forEach(result => {
            const button = document.createElement('button');
            button.textContent = `Examen: ${result.title} - Calificación: ${result.score}`;
            button.className = 'result-button';

            button.addEventListener("click", function (e) {
              e.preventDefault();
              displayResult(result, button);
            });

            container.appendChild(button);
          });
        })
        .catch((error) => console.error('Error:', error));
    };

    function displayExam(examData) {
      const examContainer = document.getElementById('exam-viz');
      examContainer.innerHTML = ''; // Limpiar el contenedor antes de mostrar un nuevo examen

      // Crear el título del examen
      const examTitle = document.createElement('h2');
      examTitle.textContent = `Responder Examen: ${examData.title}`;
      examContainer.appendChild(examTitle);

      // Crear el subtítulo del tema
      const topicSubtitle = document.createElement('h3');
      topicSubtitle.textContent = `Tema: ${examData.topic}`;
      examContainer.appendChild(topicSubtitle);

      // Crear el código del examen
      const examCodePara = document.createElement('p');
      examCodePara.textContent = `Código del Examen: ${examData.exam_code}`;
      examContainer.appendChild(examCodePara);

      // Parsear el exam_data para mostrarlo como JSON
      const examDataObj = JSON.parse(examData.exam_data);

      // Crear un elemento para mostrar las preguntas y opciones
      const examQuestionsList = document.createElement('div');
      examDataObj.preguntas.forEach((pregunta, index) => {
        const questionItem = document.createElement('div');
        questionItem.classList.add('question-item');
        const questionText = document.createElement('p');
        questionText.textContent = `${index + 1}. ${pregunta.enunciado}`;

        // Crear una lista para las opciones
        const optionsList = document.createElement('ul');
        optionsList.classList.add('options-list'); // Agregar clase para estilizar las opciones

        // Recorrer las opciones
        pregunta.opciones.forEach(opcion => {
          const optionItem = document.createElement('li');
          const radioButton = document.createElement('input');
          radioButton.type = 'radio';
          radioButton.name = `question${index}`;
          radioButton.value = opcion;
          optionItem.appendChild(radioButton);
          optionItem.appendChild(document.createTextNode(opcion));
          optionsList.appendChild(optionItem);
        });

        // Agregar el texto de la pregunta y las opciones a la lista de preguntas
        questionItem.appendChild(questionText);
        questionItem.appendChild(optionsList);
        examQuestionsList.appendChild(questionItem);
      });

      // Agregar la lista de preguntas al contenedor del examen
      examContainer.appendChild(examQuestionsList);

      // Crear botón para enviar las respuestas
      const submitButton = document.createElement('button');
      submitButton.textContent = 'Enviar';
      submitButton.className = 'btn btn-primary';
      submitButton.addEventListener('click', function () {
        submitExam(examData.id, examDataObj.preguntas);
      });
      examContainer.appendChild(submitButton);
    }

    function submitExam(examId, preguntas) {
      let score = 0;
      preguntas.forEach((pregunta, index) => {
        const radios = document.getElementsByName(`question${index}`);
        let respuestaSeleccionada;
        radios.forEach(radio => {
          if (radio.checked) {
            respuestaSeleccionada = radio.value;
          }
        });
        if (respuestaSeleccionada === pregunta.respuesta) {
          score += 1;
        }
      });

      const totalQuestions = preguntas.length;
      const finalScore = (score / totalQuestions) * 10;

      fetch('/save-exam-result', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ examId, finalScore })
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
          } else {
            alert(`Tu calificación es: ${finalScore}`);
            window.location.reload(); // Recargar la página para actualizar los resultados
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function displayResult(resultData, resultButton) {
      const resultContainer = document.getElementById('result-viz');
      resultContainer.innerHTML = ''; // Limpiar el contenedor antes de mostrar un nuevo resultado

      // Crear el título del examen
      const resultTitle = document.createElement('h2');
      resultTitle.textContent = `Resultado del Examen: ${resultData.title}`;
      resultContainer.appendChild(resultTitle);

      // Crear el subtítulo del tema
      const topicSubtitle = document.createElement('h3');
      topicSubtitle.textContent = `Tema: ${resultData.topic}`;
      resultContainer.appendChild(topicSubtitle);

      // Crear el código del examen
      const examCodePara = document.createElement('p');
      examCodePara.textContent = `Código del Examen: ${resultData.exam_code}`;
      resultContainer.appendChild(examCodePara);

      // Crear el puntaje
      const scorePara = document.createElement('p');
      scorePara.textContent = `Calificación: ${resultData.score}`;
      resultContainer.appendChild(scorePara);

      // Crear la fecha y hora
      const timestampPara = document.createElement('p');
      timestampPara.textContent = `Fecha y Hora: ${new Date(resultData.timestamp).toLocaleString()}`;
      resultContainer.appendChild(timestampPara);

      // Agregar la clase active-result al botón del resultado actual
      const activeButton = document.querySelector('.result-button.active-result');
      if (activeButton) {
        activeButton.classList.remove('active-result');
      }
      resultButton.classList.add('active-result');
    }
  </script>
</body>
</html>
